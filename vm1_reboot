# VM1 - Manual P√≥s-Reboot

> **Documento de Recupera√ß√£o de Firewall**  
> √öltima atualiza√ß√£o: 10 de Dezembro de 2025

---

## 1. Resumo da Configura√ß√£o

| Componente | Descri√ß√£o |
|------------|-----------|
| **CrowdSec** | IDS/IPS colaborativo que detecta e bloqueia amea√ßas |
| **CrowdSec Firewall Bouncer** | Aplica bloqueios via iptables/ipset |
| **WireGuard VPN** | VPN na porta UDP 443 |
| **Rede VPN** | 10.224.30.0/24 |
| **IP da VM1 na VPN** | 10.224.30.1 |
| **Interface de rede** | ens3 (p√∫blica), wg0 (VPN) |

---

## 2. Problema Conhecido

### Por que as regras n√£o persistem ap√≥s reboot?

O `netfilter-persistent` tenta carregar as regras do iptables **antes** do `crowdsec-firewall-bouncer` criar os ipsets necess√°rios.

**Ordem do problema:**

1. Sistema inicia
2. `netfilter-persistent` tenta carregar `/etc/iptables/rules.v4`
3. As regras referenciam `crowdsec-blacklists-0` e `crowdsec-blacklists-1`
4. Esses ipsets ainda **n√£o existem** (bouncer n√£o iniciou)
5. **ERRO:** `Set crowdsec-blacklists-1 doesn't exist`
6. Regras **n√£o s√£o carregadas**

**Tempo de inicializa√ß√£o:**
- `netfilter-persistent`: ~93ms
- `crowdsec-firewall-bouncer`: ~17 segundos

Por isso, √© necess√°rio aplicar as regras manualmente ap√≥s o reboot.

---

## 3. Script P√≥s-Reboot

### Op√ß√£o A: Comando √∫nico (copiar e colar)

sudo iptables -F INPUT && sudo iptables -F FORWARD && sudo iptables -t nat -F POSTROUTING && \
sudo iptables -I INPUT 1 -j CROWDSEC_CHAIN && \
sudo iptables -A INPUT -i lo -j ACCEPT && \
sudo iptables -A INPUT -i wg0 -j ACCEPT -m comment --comment "vpn-interna" && \
sudo iptables -A INPUT -p udp --dport 443 -j ACCEPT -m comment --comment "wireguard" && \
sudo iptables -A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT && \
sudo iptables -A INPUT -p icmp -j ACCEPT && \
sudo iptables -A INPUT -p tcp --dport 22 -m state --state NEW -j ACCEPT && \
sudo iptables -A INPUT -j REJECT --reject-with icmp-host-prohibited && \
sudo iptables -A FORWARD -i wg0 -j ACCEPT && \
sudo iptables -A FORWARD -o wg0 -m state --state RELATED,ESTABLISHED -j ACCEPT && \
sudo iptables -t nat -A POSTROUTING -s 10.224.30.0/24 -o ens3 -j MASQUERADE && \
echo "‚úÖ Firewall restaurado!"

### Op√ß√£o B: Criar script permanente

sudo tee /usr/local/bin/restaurar-firewall.sh << 'EOF'
#!/bin/bash
# VM1 - Restaurar Firewall P√≥s-Reboot
# Executar ap√≥s cada reinicializa√ß√£o

echo "üîß Restaurando regras de firewall..."

# Aguardar CrowdSec Bouncer criar os ipsets
sleep 5

# Verificar se CROWDSEC_CHAIN existe
if ! sudo iptables -L CROWDSEC_CHAIN -n &>/dev/null; then
    echo "‚ùå ERRO: CROWDSEC_CHAIN n√£o existe. Aguarde o bouncer iniciar."
    echo "Execute: sudo systemctl status crowdsec-firewall-bouncer"
    exit 1
fi

# Limpar regras existentes
sudo iptables -F INPUT
sudo iptables -F FORWARD
sudo iptables -t nat -F POSTROUTING

# INPUT - CrowdSec primeiro (posi√ß√£o 1)
sudo iptables -I INPUT 1 -j CROWDSEC_CHAIN

# INPUT - Loopback
sudo iptables -A INPUT -i lo -j ACCEPT

# INPUT - VPN interna
sudo iptables -A INPUT -i wg0 -j ACCEPT -m comment --comment "vpn-interna"

# INPUT - Porta WireGuard
sudo iptables -A INPUT -p udp --dport 443 -j ACCEPT -m comment --comment "wireguard"

# INPUT - Conex√µes estabelecidas
sudo iptables -A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT

# INPUT - ICMP (ping)
sudo iptables -A INPUT -p icmp -j ACCEPT

# INPUT - SSH
sudo iptables -A INPUT -p tcp --dport 22 -m state --state NEW -j ACCEPT

# INPUT - Rejeitar todo o resto
sudo iptables -A INPUT -j REJECT --reject-with icmp-host-prohibited

# FORWARD - Tr√°fego da VPN
sudo iptables -A FORWARD -i wg0 -j ACCEPT
sudo iptables -A FORWARD -o wg0 -m state --state RELATED,ESTABLISHED -j ACCEPT

# NAT - Masquerade para VPN acessar internet
sudo iptables -t nat -A POSTROUTING -s 10.224.30.0/24 -o ens3 -j MASQUERADE

echo "‚úÖ Firewall restaurado com sucesso!"
echo ""
echo "Verificando regras..."
sudo iptables -L INPUT -n --line-numbers
EOF

sudo chmod +x /usr/local/bin/restaurar-firewall.sh
echo "Script criado em /usr/local/bin/restaurar-firewall.sh"

**Para executar o script:**

sudo /usr/local/bin/restaurar-firewall.sh

---

## 4. Comando de Verifica√ß√£o

Execute ap√≥s restaurar para confirmar que tudo est√° funcionando:

echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó" && \
echo "‚ïë     VM1 - VERIFICA√á√ÉO COMPLETA         ‚ïë" && \
echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù" && \
echo -e "\n=== SERVI√áOS ===" && \
echo -n "crowdsec: " && sudo systemctl is-active crowdsec && \
echo -n "bouncer: " && sudo systemctl is-active crowdsec-firewall-bouncer && \
echo -n "wireguard: " && sudo systemctl is-active wg-quick@wg0 && \
echo -e "\n=== INPUT ===" && \
sudo iptables -L INPUT -n --line-numbers && \
echo -e "\n=== CROWDSEC CHAIN ===" && \
sudo iptables -L CROWDSEC_CHAIN -n && \
echo -e "\n=== FORWARD ===" && \
sudo iptables -L FORWARD -n && \
echo -e "\n=== NAT ===" && \
sudo iptables -t nat -L POSTROUTING -n

**Resultado esperado:**

=== SERVI√áOS ===
crowdsec: active
bouncer: active
wireguard: active

=== INPUT ===
num  target              prot opt source    destination
1    CROWDSEC_CHAIN      0    --  0.0.0.0/0 0.0.0.0/0
2    ACCEPT              0    --  0.0.0.0/0 0.0.0.0/0    (lo)
3    ACCEPT              0    --  0.0.0.0/0 0.0.0.0/0    (vpn-interna)
4    ACCEPT              17   --  0.0.0.0/0 0.0.0.0/0    udp dpt:443
5    ACCEPT              0    --  0.0.0.0/0 0.0.0.0/0    state RELATED,ESTABLISHED
6    ACCEPT              1    --  0.0.0.0/0 0.0.0.0/0    (icmp)
7    ACCEPT              6    --  0.0.0.0/0 0.0.0.0/0    tcp dpt:22
8    REJECT              0    --  0.0.0.0/0 0.0.0.0/0    reject-with icmp-host-prohibited

---

## 5. Explica√ß√£o das Regras

### Chain INPUT (ordem importa!)

| # | Regra | Descri√ß√£o |
|---|-------|-----------|
| 1 | `CROWDSEC_CHAIN` | Primeira verifica√ß√£o! Checa se IP est√° na blacklist do CrowdSec |
| 2 | `-i lo` | Aceita tr√°fego interno (loopback 127.0.0.1) |
| 3 | `-i wg0` | Aceita todo tr√°fego vindo da interface VPN |
| 4 | `udp --dport 443` | Aceita conex√µes WireGuard (handshake) |
| 5 | `RELATED,ESTABLISHED` | Aceita respostas de conex√µes j√° estabelecidas |
| 6 | `-p icmp` | Aceita ping (√∫til para diagn√≥stico) |
| 7 | `tcp --dport 22` | Aceita novas conex√µes SSH |
| 8 | `REJECT` | Bloqueia e rejeita todo o resto |

### Chain FORWARD

| Regra | Descri√ß√£o |
|-------|-----------|
| `-i wg0 -j ACCEPT` | Encaminha tr√°fego vindo da VPN para internet |
| `-o wg0 ESTABLISHED` | Retorna respostas para a VPN |

### NAT (POSTROUTING)

| Regra | Descri√ß√£o |
|-------|-----------|
| `MASQUERADE` | Traduz IPs da VPN (10.224.30.x) para o IP p√∫blico da VM1 |

---

## 6. Comandos √öteis

### CrowdSec

# Ver IPs banidos
sudo cscli decisions list

# Desbanir um IP espec√≠fico
sudo cscli decisions delete --ip X.X.X.X

# Ver alertas
sudo cscli alerts list

# Status do CrowdSec
sudo cscli metrics

# Logs em tempo real
sudo journalctl -u crowdsec -f

# Logs do bouncer
sudo journalctl -u crowdsec-firewall-bouncer -f

### WireGuard

# Status da VPN
sudo wg show

# Ver configura√ß√£o
sudo cat /etc/wireguard/wg0.conf

# Reiniciar WireGuard
sudo systemctl restart wg-quick@wg0

# Ver logs
sudo journalctl -u wg-quick@wg0

### Firewall

# Ver todas as regras INPUT
sudo iptables -L INPUT -n -v --line-numbers

# Ver regras NAT
sudo iptables -t nat -L -n -v

# Ver regras FORWARD
sudo iptables -L FORWARD -n -v

# Ver ipsets do CrowdSec
sudo ipset list -n

# Contar IPs bloqueados
sudo ipset list crowdsec-blacklists-0 | wc -l

---

## 7. Arquivos Importantes

| Arquivo | Descri√ß√£o |
|---------|-----------|
| `/etc/wireguard/wg0.conf` | Configura√ß√£o do WireGuard |
| `/etc/crowdsec/config.yaml` | Configura√ß√£o principal do CrowdSec |
| `/etc/crowdsec/bouncers/crowdsec-firewall-bouncer.yaml` | Configura√ß√£o do bouncer |
| `/etc/iptables/rules.v4` | Regras salvas (n√£o funciona no boot) |
| `/usr/local/bin/restaurar-firewall.sh` | Script de restaura√ß√£o (se criado) |

---

## 8. Checklist P√≥s-Reboot

Ap√≥s cada reinicializa√ß√£o, siga esta ordem:

1. [ ] Conectar via SSH
2. [ ] Verificar servi√ßos: `sudo systemctl is-active crowdsec crowdsec-firewall-bouncer wg-quick@wg0`
3. [ ] Aguardar ~20 segundos para bouncer criar ipsets
4. [ ] Executar script de restaura√ß√£o ou comando √∫nico
5. [ ] Verificar regras com comando de verifica√ß√£o
6. [ ] Testar VPN no dispositivo cliente

---

## 9. Troubleshooting

### VPN n√£o conecta

# Verificar se WireGuard est√° rodando
sudo systemctl status wg-quick@wg0

# Verificar porta 443 aberta
sudo ss -ulnp | grep 443

# Verificar regra no firewall
sudo iptables -L INPUT -n | grep 443

### CrowdSec n√£o est√° bloqueando

# Verificar se bouncer est√° ativo
sudo systemctl status crowdsec-firewall-bouncer

# Verificar se CROWDSEC_CHAIN existe
sudo iptables -L CROWDSEC_CHAIN -n

# Verificar ipsets
sudo ipset list -n

### Internet n√£o funciona pela VPN

# Verificar IP forward
cat /proc/sys/net/ipv4/ip_forward  # Deve ser 1

# Verificar NAT
sudo iptables -t nat -L POSTROUTING -n

# Verificar FORWARD
sudo iptables -L FORWARD -n

---

**Documento criado para VM1 - Oracle Cloud**  
**Mantenha este documento salvo para refer√™ncia futura!**
